{
  Stopwatch watch=new Stopwatch();
  watch.start();
  mBlocks=new ArrayList<CompiledKernel>();
  m_HandlesList.clear();
  mWriteRet=new PartiallyCompletedParallelJob(jobs);
  CompiledKernel first_block=getBlock(jobs);
  mUsingGarbageCollector=false;
  mGcObjectVisitor=first_block.getSerializer(mToSpaceMemory,mTextureMemory);
  mHeapEndPtrMemory.setAddress(0);
  mHandlesMemory.setAddress(0);
  mToSpaceMemory.setAddress(0);
  mToSpaceMemory.clearHeapEndPtr();
  if (mUsingGarbageCollector) {
    makeSureReadyForUsingGarbageCollector();
  }
  mGcObjectVisitor.writeStaticsToHeap();
  m_PreviousRef=0;
  m_PreviousSize=0;
  m_CountWritten=1;
  mMaxToHandleMapAddress=-1;
  writeOneRuntimeBasicBlock(first_block);
  while (jobs.hasNext()) {
    if (roomForMore(m_PreviousSize,m_PreviousRef) == false) {
      break;
    }
    m_CountWritten++;
    CompiledKernel block=getBlock(jobs);
    writeOneRuntimeBasicBlock(block);
  }
  long heap_end_ptr=mToSpaceMemory.getHeapEndPtr();
  mHeapEndPtrMemory.writeLong(heap_end_ptr);
  mToSpaceMemory.finishCopy(mToSpaceMemory.getHeapEndPtr());
  mHandlesMemory.finishCopy(m_CountWritten * 8);
  if (mUsingGarbageCollector) {
    mToHandleMapMemory.finishCopy(mMaxToHandleMapAddress);
  }
  mHeapEndPtrMemory.finishCopy(8);
  if (Configuration.getPrintMem()) {
    BufferPrinter printer=new BufferPrinter();
    printer.print(mToSpaceMemory,0,1024);
  }
  return m_CountWritten;
}
